<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ar-qr-tracer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

  <style>
    body { margin: 0; overflow: hidden; font-family: sans-serif; }

    /* Instructions box */
    #instructions {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding: 12px 20px;
      border-radius: 12px;
      z-index: 10;
      text-align: center;
      max-width: 90%;
      line-height: 1.4;
    }

    /* File input */
    #fileInput {
      position: absolute;
      top: 100px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
    }

    #fileInput::-webkit-file-upload-button {
      padding: 8px 12px;
      font-size: 16px;
    }
  </style>
</head>
<body>
<div id="instructions">
  Draw or place a Kanji marker on the wall. <br>
  Point your camera at it to place the QR overlay. <br>
  Use the button below to load your QR image. <br>
  Pinch to scale the QR plane if needed.
</div>

<input type="file" id="fileInput" accept="image/*">

<a-scene
  embedded
  arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">

  <!-- Kanji marker -->
  <a-marker preset="kanji" emitevents="true">
    <!-- Semi-transparent QR plane above marker -->
    <a-plane
      id="qrPlane"
      opacity="0.35"
      material="transparent: true; side: double"
      position="0 0.6 0"
      rotation="-90 0 0"
      height="1"
      width="1"
      pinch-scale>
    </a-plane>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<a-assets>
  <img id="qrTexture" src="https://upload.wikimedia.org/wikipedia/commons/2/2f/QR_code_for_mobile_English_Wikipedia.png">
</a-assets>

<script>
/* Dynamic QR loader */
const fileInput = document.getElementById('fileInput');
const qrPlane = document.getElementById('qrPlane');

fileInput.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const dataURL = e.target.result;
    qrPlane.setAttribute('material', `src: url(${dataURL}); transparent: true; opacity: 0.35; side: double;`);
  }
  reader.readAsDataURL(file);
});

/* Pinch-to-scale component */
AFRAME.registerComponent('pinch-scale', {
  init: function() {
    const el = this.el;
    let initialDistance = null;
    let initialScale = el.object3D.scale.clone();

    function getDistance(touches) {
      const dx = touches[0].clientX - touches[1].clientX;
      const dy = touches[0].clientY - touches[1].clientY;
      return Math.sqrt(dx*dx + dy*dy);
    }

    function touchStart(e) {
      if (e.touches.length === 2) {
        initialDistance = getDistance(e.touches);
        initialScale = el.object3D.scale.clone();
      }
    }

    function touchMove(e) {
      if (e.touches.length === 2 && initialDistance) {
        const currentDistance = getDistance(e.touches);
        const scaleFactor = currentDistance / initialDistance;
        el.object3D.scale.set(
          initialScale.x * scaleFactor,
          initialScale.y * scaleFactor,
          initialScale.z * scaleFactor
        );
      }
    }

    function touchEnd(e) {
      if (e.touches.length < 2) initialDistance = null;
    }

    el.sceneEl.canvas.addEventListener('touchstart', touchStart, false);
    el.sceneEl.canvas.addEventListener('touchmove', touchMove, false);
    el.sceneEl.canvas.addEventListener('touchend', touchEnd, false);
  }
});
</script>
</body>
</html>